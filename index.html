<!DOCTYPE html>
<html>
<head>
    <title>Bluefruit Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial; 
            margin: 20px; 
            text-align: center;
        }
        #terminal {
            width: 80%;
            height: 200px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ccc;
            overflow-y: scroll;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Bluefruit BLE Test</h1>
    <button id="connectBtn" onclick="connect()">Connect</button>
    <div id="terminal"></div>
    <input type="text" id="input" placeholder="Type message">
    <button onclick="send()">Send</button>

    <script>
        let bluetoothDevice;
        let txCharacteristic;
        let rxCharacteristic;
        let terminal = document.getElementById('terminal');

        async function connect() {
            try {
                terminal.insertAdjacentHTML('beforeend', 'Requesting device...\n');
                
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{name: 'Bluefruit52'}],
                    optionalServices: [0x6e400001-b5a3-f393-e0a8-e50e24dcca9e]
                });

                terminal.insertAdjacentHTML('beforeend', 'Connecting...\n');
                const server = await bluetoothDevice.gatt.connect();

                terminal.insertAdjacentHTML('beforeend', 'Getting Service...\n');
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a8-e50e24dcca9e');

                terminal.insertAdjacentHTML('beforeend', 'Getting Characteristics...\n');
                rxCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a8-e50e24dcca9e');
                txCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a8-e50e24dcca9e');

                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleData);
                
                terminal.insertAdjacentHTML('beforeend', 'Connected!\n');
            } catch(error) {
                terminal.insertAdjacentHTML('beforeend', 'Error: ' + error + '\n');
            }
        }

        function handleData(event) {
            let value = event.target.value;
            let str = new TextDecoder().decode(value);
            terminal.insertAdjacentHTML('beforeend', 'Received: ' + str + '\n');
            terminal.scrollTop = terminal.scrollHeight;
        }

        function send() {
            if (!rxCharacteristic) {
                terminal.insertAdjacentHTML('beforeend', 'Not connected\n');
                return;
            }
            
            let input = document.getElementById('input');
            let data = new TextEncoder().encode(input.value);
            rxCharacteristic.writeValue(data);
            terminal.insertAdjacentHTML('beforeend', 'Sent: ' + input.value + '\n');
            input.value = '';
            terminal.scrollTop = terminal.scrollHeight;
        }
    </script>
</body>
</html>
